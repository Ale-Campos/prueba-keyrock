<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
<style type="text/css">

.block {
    background: #f2f2f2;
    position: relative;
    padding: 15px;
    border: 1px solid #ccc;
    &:not(:first-child) {
        margin-top: 10px;
    }
}

.collapse_out {
    cursor: text;
}

.block:hover {
    cursor: move;
}

.panel-body {
    padding: 0px;
}

.iot_panel {
    width: 100%;
}

#iot_group_list > .iot_panel {
    border-bottom: 1px solid #ccc;
    margin: 10px 0px 10px 0px;
}

#iot_individual_list > .iot_panel > header {
    border-bottom: 1px solid #ccc;
    margin: 10px 0px 10px 0px;
}

#iot_group_list {
    border-left: 1px solid #ccc;
}

.delete_group {
    margin-bottom: 10px;
    float: right;
}

.block-actions > a.ajax-inline-edit {
    right: 27px;
    top: 9px;
    margin-left: 5px;
}

.block-actions > a.delete {
    right: 2px;
    margin-left: 7px;
}

.block-actions > h4.panel-title {
    width: 80%;
    overflow: hidden;
    text-overflow: ellipsis;
    right: 7px;
}

#iot_individual_message,
#iot_groups_message {
    width: 100%;
}

</style>
<div id="content_body">
    <div id="create_application_iots">
        <div class="workflow workflow-roles static_page">
            <form id="manage_iot_agents_form" action="/idm/applications/<%= application.id %>/iot_agents" method="POST">
                <input type='hidden' name='_csrf' value='<%= csrfToken%>' />
                <input type="hidden" id="submit_iot_agents" name="submit_iot_agents" value="" />
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Manage Iot Agents</h3>
                        </div>

                        <div class="builder">
                            <div class="builder-body">
                                <div class="panel panel-default panel-body sortable">
                                    <div class="column-container">
                                        <section id="iot_individual_list" class="role_list">
                                            <div class="col-xs-6 column sortable iot_panel">
                                                <header>
                                                    <h4>Iot Agents</h4>
                                                    <button type="button" class="btn addIot">
                                                        <i class="fa fa-plus"></i>
                                                    </button>
                                                </header>
                                                <div class="blocks panel panel-default panel-body">
                                                     
                                                </div>
                                                <div class="col-xs-6 alert alert-info" style="display: none;" id="iot_individual_message">
                                                    There aren't IoT agents
                                                </div>
                                            </div>
                                        </section>

                                        <section id="iot_group_list" class="role_list">
                                            <div class="col-xs-6 column iot_panel">
                                                <header>
                                                    <h4>Iot Groups</h4>
                                                    <button id="addGroupIot" type="button" class="btn ajax-modal">
                                                        <i class="fa fa-plus"></i>
                                                    </button>
                                                </header>
                                            </div>
                                            <div class="col-xs-6 alert alert-info" style="display: none;" id="iot_groups_message">
                                                There aren't IoT groups
                                            </div> 
                                        </section>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <input class="btn btn-primary pull right" type="submit" value="Save" />
                </div>
            </form> 
        </div>
    </div>
</div>  

<div class="messages"></div>

<script type="text/javascript">
    $('.panel-title a:first-child').mouseover(function(){
        $(this).children().toggleClass('fa-rotate-180');
    });
    $('.panel-title a:first-child').mouseleave(function(){
        if ($(this).hasClass('collapsed')){
            $(this).children().removeClass('fa-rotate-180');
        } else {
            $(this).children().addClass('fa-rotate-180');
        }
    });
    $('.panel-title a:first-child').click(function(){
        if ($(this).hasClass('collapsed')){
            $(this).children().addClass('fa-rotate-180');
        } else {
            $(this).children().removeClass('fa-rotate-180');
        }
    });
</script>

<script type="text/javascript">
    $(function () {
        $('[data-toggle="popover"]').popover({html:true});
        $('[data-toggle="tooltip"]').tooltip();
    });
</script>

<script type="text/javascript">
    $(document).ready(function(){

        if ($('#iot_group_list').find('.iot_panel').length < 2) {
            $('#iot_groups_message').show()
            $('.blocks').hide()
        }

        if ($('#iot_individual_list').find('.blocks').find('.block').length < 1) {
            $('#iot_individual_message').show()
        }


        function make_panels_sortable() {
            // Block Controls
            $(".blocks").sortable({
                connectWith: '.blocks',
                placeholder: 'block-placeholder',
                revert: true,
                cancel: ".blocks .collapse_out",
                start: function(e, ui) {

                    placeholderHeight = ui.item.outerHeight();
                    ui.placeholder.height(placeholderHeight + 15);
                    $('<div class="block-placeholder-animator" data-height="' + placeholderHeight + '"></div>').insertAfter(ui.placeholder);

                },
                change: function(event, ui) {

                    ui.placeholder.stop().height(0).animate({
                        height: ui.item.outerHeight() + 15
                    }, 300);

                    placeholderAnimatorHeight = parseInt($(".block-placeholder-animator").attr("data-height"));

                    $(".block-placeholder-animator").stop().height(placeholderAnimatorHeight + 15).animate({
                        height: 0
                    }, 300, function() {
                        $(this).remove();
                        placeholderHeight = ui.item.outerHeight();
                        $('<div class="block-placeholder-animator" data-height="' + placeholderHeight + '"></div>').insertAfter(ui.placeholder);
                    });

                },
                stop: function(e, ui) {

                    $(".block-placeholder-animator").remove();

                },
            });     
        }


        // Init blocks to be sortables
        make_panels_sortable()

        // Add new iot agent
        $('#create_application_iots').on("click", '.addIot', function() {

            $(this).closest('.iot_panel').find('.blocks').show()
            $(this).closest('.iot_panel').find('#iot_individual_message').hide()

            var id_iot_agent = 'id_iot_' + Math.random().toString(36).substring(7);
            var name_iot_agent = 'name_iot_' + Math.random().toString(36).substring(7);
            var password_iot_agent = 'password_iot_' + Math.random().toString(36).substring(7);

            var iot_row = $('#iot_row_template').html();
            iot_row = iot_row.replace(/iot_name/g, name_iot_agent);
            iot_row = iot_row.replace(/iot_id/g, id_iot_agent);
            iot_row = iot_row.replace(/iot_password/g, password_iot_agent);

            $(this).closest('.column').find('.blocks').append(iot_row);
        });

        // Delete iot agent
        $('#create_application_iots').on("click", '.delete', function() {
            // stop form from submitting normally
            event.preventDefault();

            $(this).closest('div.block').remove()
        });

        // Add new groups
        $('#addGroupIot').click(function() {

            var id_iot_group = 'id_group_' + Math.random().toString(36).substring(7);
            var name_iot_group = 'name_group_' + Math.random().toString(36).substring(7);

            var iot_group_row = $('#iot_group_row_template').html();
            iot_group_row = iot_group_row.replace(/iot_group_id/g, id_iot_group);
            iot_group_row = iot_group_row.replace(/iot_group_name/g, name_iot_group);

            $('#iot_group_list').append(iot_group_row)

            var groups = $('#iot_group_list').find('.iot_panel')

            if (groups.length >= 2) {
                $('#iot_groups_message').hide()
            }

            // Make new panel sortable
            make_panels_sortable()
        });

        // Delete groups
        $('#create_application_iots').on("click", '.delete_group', function(event) {
            // stop form from submitting normally
            event.preventDefault();

            $(this).closest('div.iot_panel').remove()

            var groups = $('#iot_group_list').find('.iot_panel')

            if (groups.length < 2) {
                $('#iot_groups_message').show()
            }
        });

        $.fn.extend({
            removeclasser: function(re) {
                return this.each(function() {
                    var c = this.classList
                    for (var i = c.length - 1; i >= 0; i--) {
                        var classe = "" + c[i]
                        if (classe.match(re)) c.remove(classe)
                    }
            })
                return re;
            },
            translatecolumn: function(columns) {
                var grid = [];
                var items = columns.split(',');
                for (i = 0; i < items.length; ++i) {
                    if (items[i] == '1') {
                        grid.push(12);
                    }
                    if (items[i] == '2') {
                        grid.push(6);
                    }
                    if (items[i] == '3') {
                        grid.push(4);
                    }
                }
                return grid;
            }
        });
    })
</script>



<script type="text/x-custom-template" id="iot_row_template">
    <div class="block clearfix">
        <div class="block-actions">
            <h4 class="panel-title pull-left">
                <a data-toggle="collapse" href="#iot_id" aria-expanded="true" aria-controls="iot_id" class="collapsed">iot_name<i class="fa fa-angle-up"></i></a>
            </h4>
            <a href="#" class="ajax-inline-edit" data-toggle="tooltip" data-placement="bottom" title="Reset Password of Iot Agent">
                <i class="fa fa-refresh"></i>
            </a>
            <a href="#" class="ajax-modal delete" data-toggle="tooltip" data-placement="bottom" title="Delete Iot Agent">
                <i class="fa fa-trash-o"></i>
            </a>
            <div class="collapse_out">
                <div id="iot_id" class="form-group collapse" role="tabpanel">
                    <div class="extra">
                        <h6 class="panel-heading">Username:</h6>
                        <p>iot_id</p>
                        <h6 class="panel-heading">Password:</h6>
                        <p>iot_password</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</script>

<script type="text/x-custom-template" id="iot_group_row_template">
    <div id='iot_group_id' class="col-xs-6 column sortable iot_panel">
        <header>
            <h4>iot_group_name</h4>
            <button type="button" class="btn ajax-modal addIot">
                <i class="fa fa-plus"></i>
            </button>
        </header>
        <div class="blocks panel panel-default panel-body">
        </div>
        <button class="btn btn-danger delete_group" type="submit">Delete Group</button>
    </div>
</script>